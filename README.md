# Universal Web API

> 💡 **一句话介绍**：将任何你常用的 AI 网站（ChatGPT, DeepSeek, Claude, Gemini 等）转换为标准的 OpenAI 兼容 API 接口，完全免费，支持本地部署。

## 📖 目录
1. [项目简介](#-项目简介)
2. [小白快速开始](#-小白快速开始)
3. [连接 API](#-连接-api)
4. [标签页池与预设系统](#-标签页池与预设系统)
5. [核心功能配置](#-核心功能配置)
6. [高级配置](#-高级配置)
7. [重要注意事项与已知限制](#-重要注意事项与已知限制)
8. [常见问题 (FAQ)](#-常见问题-faq)
9. [项目结构](#-项目结构)
10. [免责声明](#-免责声明)

---

## 💡 项目简介

这是一个基于 **浏览器自动化 (DrissionPage)** 技术的工具。它就像一个"机器人助理"，会在你的电脑上打开一个浏览器窗口，模仿人类的操作去和 AI 网页对话，然后把 AI 的回复通过标准 API 接口传回来给你。

**核心优势：**
* ✅ **0 成本**：直接利用网页版的免费对话额度。
* ✅ **数据安全**：账号在你自己本地登录，Cookie 不会上云，隐私完全掌握在自己手中。
* ✅ **高度智能**：内置 AI 语义分析引擎，不需要你去查网页源代码，只要告诉机器人"输入框在哪里"，它就能自己找到。
* ✅ **多标签并发**：支持同时打开多个标签页，自动调度，实现并行请求。
* ✅ **预设系统**：为同一站点创建多套配置方案（如对话、识图、代码），分配给不同标签页。

**已适配的站点：**

| 站点 | 地址 | 备注 |
|------|------|------|
| ChatGPT | chatgpt.com | 约 200k 单次最大发送长度 |
| DeepSeek | chat.deepseek.com | 思考模式下存在读取问题 |
| Gemini | gemini.google.com | 无会员约 30k，Pro 会员尚未发现上限 |
| Grok | grok.com | — |
| 豆包 | doubao.com | — |
| AI Studio | aistudio.google.com | — |
| Arena AI | arena.ai | IP 质量敏感，详见注意事项 |
| H2O GPT | h2ogpte.genai.h2o.ai | — |

> 对于未收录的网站，系统支持通过 AI 自动分析网页结构进行适配，详见「AI 元素识别」章节。

---

## 💬 交流群

如果遇到问题，可加 QQ 群 **1073037753** 交流反馈。

---

## 🚀 小白快速开始

### 1. 下载与安装

1. 下载 Release 中的压缩包。
2. 解压到一个 **没有中文路径** 的文件夹里（例如 `D:\AI_Tools\Universal-Web-API`）。
3. 确保你的电脑上安装了以下任一 Chromium 内核浏览器：
   - Google Chrome（推荐）
   - Microsoft Edge（Windows 10/11 自带）
   - Brave / Vivaldi / Opera

### 2. 启动与进入配置页面

1. 双击运行文件夹里的 **`start.bat`** 脚本。
   * 脚本会自动检测环境并安装必要的依赖，第一次运行可能需要一点时间，请耐心等待。
   * 脚本还会自动执行 DrissionPage 补丁（用于隐身模式优化）。
2. 当出现黑色命令行窗口（CMD）并停止滚动时，你会看到类似下面的提示：
   ```text
   Web UI 已启动，请访问: http://127.0.0.1:8199
   ```
3. **如何打开配置界面**：
   * 按住键盘上的 **Ctrl** 键，鼠标点击这个链接。
   * 或者手动复制 `http://127.0.0.1:8199` 到你的浏览器地址栏打开。

### 3. 登录账号

程序启动后，会自动弹出一个浏览器窗口（Chrome、Edge 或其他已检测到的 Chromium 内核浏览器）。

1. 在这个自动弹出的浏览器里，打开你要使用的 AI 网站。
2. **手动登录你的账号**。
   * **推荐登录**：登录后 API 也就拥有了你的账号权限（如 Plus 会员、历史记录等）。
   * **免登录**：如果该网站在未登录状态下允许对话（如 LM Arena），则无需登录即可直接调用。
3. 登录成功后，**不要关闭浏览器**，回到刚才打开的 Web UI 网页（8199 端口）开始配置。

> ⚠️ 教程页面看完后记得关闭，不要在脚本控制的浏览器中保留除 AI 网站之外的标签页。

---

## 🔌 连接 API

本项目提供兼容 **OpenAI 格式**的接口，可以对接任何支持 OpenAI API 的客户端。

### 通用配置参数

| 配置项 | 填写内容 |
|--------|----------|
| **服务提供商** | 选择 `OpenAI`、`OpenAI 兼容` 或 `自定义` |
| **API 接口地址** | `http://127.0.0.1:8199/v1`（默认，自动分配标签页）|
| **API 密钥** | 任意填写即可（例如：`sk-any`）|
| **模型名称** | 任意填写（实际模型取决于你访问的网站）|

### 路由方式

| 路由 | 地址格式 | 说明 |
|------|----------|------|
| **默认路由** | `/v1/chat/completions` | 自动选择一个空闲标签页处理请求 |
| **指定标签页** | `/tab/{编号}/v1/chat/completions` | 使用特定编号的标签页（编号见控制面板的标签页池）|

> 部分客户端需要填写完整路径：`http://127.0.0.1:8199/v1/chat/completions`

### 调用示例

```bash
curl http://127.0.0.1:8199/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-any" \
  -d '{
    "model": "any",
    "messages": [{"role": "user", "content": "你好"}],
    "stream": true
  }'
```

### 关于 SillyTavern（酒馆）

> ⚠️ 酒馆的 API 测试功能可能出现 bug，**建议直接发送对话进行测试**，而非点击测试按钮。酒馆测试时发送的请求信息过短，特别是配合 AI Studio 时容易失败。

---

## 🗂️ 标签页池与预设系统

### 标签页池

标签页池是本项目的核心调度机制。脚本会自动扫描浏览器中打开的所有 AI 网站标签页，并为每个标签页分配一个**持久编号**。

**工作原理：**
1. 你在浏览器中打开一个或多个 AI 网站标签页
2. 脚本自动检测并将它们加入标签页池，分配编号（1, 2, 3...）
3. API 请求到达时，自动选择一个空闲的标签页来处理
4. 处理完成后，标签页被释放回池中，等待下一个请求

**在控制面板中管理：**
- 查看所有标签页的实时状态（空闲/忙碌/错误）
- 查看每个标签页的当前 URL 和请求计数
- 复制指定标签页的 API 端点地址
- 为标签页切换不同的预设配置

> 注意：`chrome://newtab` 等空白页不会被加入池，页面需加载完成后才会被识别。标签页编号在脚本运行期间保持不变，重启后会重新分配。

### 预设系统

预设系统允许你为同一个站点创建**多套独立的配置方案**，并将不同预设分配给不同的标签页。

**典型应用场景：**

| 标签页 | 预设名称 | 配置差异 |
|--------|----------|----------|
| 标签页 #1 | Pro 模型对话 | 完整工作流、较长超时、启用深度提取 |
| 标签页 #2 | 快速识图 | 简化工作流、启用图片提取、较短超时 |
| 标签页 #3 | 代码助手 | 启用文件粘贴、高阈值、启用网络拦截模式 |

**使用步骤：**
1. **创建预设**：在控制面板中选择站点 → 配置选项卡 → 点击「＋ 新建预设」
2. **分配预设**：切换到「标签页」选项卡 → 在标签页行中选择预设
3. **通过 API 调用**：使用 `/tab/{编号}/v1/chat/completions` 访问指定标签页

> 每个预设包含独立的选择器、工作流、流式配置、图片提取、文件粘贴等全套配置，互不影响。

---

## ⚙️ 核心功能配置

### 选择器配置 (Selectors)

每个站点需要定义一组 CSS 选择器，告诉程序去哪里输入、哪里点击：

| 选择器 | 必需 | 说明 |
|--------|------|------|
| `input_box` | ✅ | 聊天输入框 |
| `send_btn` | ✅ | 发送按钮 |
| `result_container` | ✅ | AI 回复内容的容器 |
| `new_chat_btn` | ❌ | 新建对话按钮 |

> 💡 你可以自定义更多选择器（如「临时对话按钮」），然后在工作流里添加对应的点击步骤。在控制面板的选择器配置项中点击「测试」按钮可以验证选择器是否生效。

### 工作流配置 (Workflow)

定义一系列动作的执行顺序：

```json
[
  { "action": "CLICK", "target": "new_chat_btn" },
  { "action": "WAIT", "value": 0.5 },
  { "action": "FILL_INPUT", "target": "input_box" },
  { "action": "CLICK", "target": "send_btn" },
  { "action": "STREAM_WAIT" }
]
```

| 动作类型 | 说明 |
|----------|------|
| `CLICK` | 点击元素（target 为选择器 key）|
| `FILL_INPUT` | 在输入框填入用户问题 |
| `WAIT` | 等待固定时间（value 为秒数）|
| `KEY_PRESS` | 模拟按键（如 Enter）|
| `STREAM_WAIT` | 等待响应完成 |

**对于小白用户**，大部分主流网站已经预设好了配置，通常只需要关注三个要素：

| 设置项 | 说明 | 示例 |
|--------|------|------|
| **Key (元素名)** | 给这个操作对象起个英文名 | `input_box` |
| **描述** | 用大白话描述这是什么，AI 会根据描述去网页里找 | `这是聊天的输入框` |
| **是否启用** | 勾选后机器人才会操作这一步 | `☑️` |

### 提取器配置 (Extractors)

提取器决定如何从网页 HTML 中解析出干净的 Markdown 文本：

- **默认模式**：自动提取 `result_container` 中的文本
- **深度模式 (deep_mode)**：针对复杂的 LaTeX 公式、代码块进行特殊处理（**推荐**）

> ⚠️ 目前只有深度模式经过深度优化，其他模式处于未完善状态。即使是深度模式，某些复杂代码块也可能无法正确处理，此时可切换为网络拦截模式。

### 响应检测配置

支持两种检测模式：

| 模式 | 是否流式 | 说明 |
|------|----------|------|
| **DOM 模式**（默认） | ✅ 流式 | 轮询检测页面 DOM 变化，实时输出内容 |
| **网络拦截模式** | ❌ 非流式 | 拦截浏览器网络请求，AI 生成完毕后一次性返回 |

**DOM 模式调优建议：**

| 场景 | 静默超时阈值 | 稳定判定次数 | 初始等待 |
|------|-------------|-------------|----------|
| 快速模型 (GPT-4o) | 3-5 秒 | 3-5 次 | 60 秒 |
| 慢速思考 (o1/Claude) | 10-15 秒 | 8-12 次 | 300 秒 |
| 代码生成 | 8-10 秒 | 6-8 次 | 180 秒 |
| 长文生成 | 12-15 秒 | 10 次 | 300 秒 |

> ⚠️ **关于网络拦截模式**：目前仅针对部分站点做了适配。如果某个站点默认没有开启网络拦截，**请不要手动开启**——大概率是没有适配，或者开启后会增加被检测的风险。

### 图片提取配置

配置程序如何处理网页中生成的图片：

```json
{
  "enabled": true,
  "selector": "img",
  "container_selector": ".img-grid",
  "download_blobs": true,
  "mode": "all",
  "max_size_mb": 10
}
```

- **发送的图片**保存在根目录 `image/`
- **捕获的图片**保存在根目录 `download_images/`

### 文件粘贴

当发送的文本长度超过设定阈值时，系统会自动将文本写入临时 `.txt` 文件，然后以文件粘贴的方式发送到输入框，绕过部分网站对输入框字符数的限制。

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 启用 | 关闭 | 是否开启文件粘贴模式 |
| 阈值 | `50000` 字符 | 文本超过此值时触发 |
| 引导文本 | `完全专注于文件内容` | 粘贴文件后自动追加的文字 |

> 💡 仅适用于**支持文件上传**的 AI 网站（如 Gemini、ChatGPT）。

---

## 🔧 高级配置

### 隐身模式 (Stealth Mode)

开启后，脚本的所有操作会加入随机延迟和模拟人类特征，防止被网站识别为脚本。

| 行为 | 普通模式 | 隐身模式 |
|------|----------|----------|
| 鼠标点击 | 直接 CDP 命令 | 模拟真实鼠标按压（含 pressure、微移、释放偏移）|
| 鼠标移动 | 瞬间跳转 | 人类化曲线移动 |
| 空闲时 | 无动作 | 随机微漂移（模拟手部抖动）|
| 操作间隔 | 最小延迟 | 随机化延迟（0.1-0.3 秒）|

**使用建议：**
- **需要开启**：访问有 Cloudflare 防护的站点（如 arena.ai、chatgpt.com）
- **不需要开启**：访问无防护或低防护的站点（如 AI Studio、DeepSeek）
- 如果网站没有强制弹验证码，建议**不开启**以提高运行速度

> ⚠️ **高强度防御无法绕过**：对于 Cloudflare 盾等级调得非常高的网站（如 arena.ai），即使开启隐身模式也可能被拦截。arena.ai 在半小时内连续对话约 10 条几乎一定会触发人机验证，真人操作也同样如此。

**DrissionPage 补丁**：`start.bat` 会在依赖安装后自动执行补丁。也可以手动执行：
```bash
python patch_drissionpage.py          # 执行补丁
python patch_drissionpage.py --restore # 恢复原文件
```
> 每次升级 DrissionPage 后需要重新执行补丁。

### AI 元素识别

当你访问的站点不在已适配列表中时，系统可以调用 AI 自动分析网页结构，识别出输入框、发送按钮等关键元素。

**默认识别项：**

| 关键词 | 描述 | 必需 |
|--------|------|------|
| `input_box` | 用户输入文本的输入框 | ✅ |
| `send_btn` | 发送消息的按钮 | ✅ |
| `result_container` | AI 回复内容的容器 | ✅ |
| `new_chat_btn` | 新建对话的按钮 | ❌ |
| `message_wrapper` | 消息完整容器 | ❌ |
| `generating_indicator` | 生成中指示器 | ❌ |

**使用流程：**
1. 在控制面板 → 设置 → AI 分析配置中，填写你自己的 OpenAI 格式 API 地址和 Key
2. 在浏览器中打开未适配的网站
3. 向本服务发送一条测试消息，系统会自动调用 API 分析网页（约消耗 **8000 tokens**）

> 如果你只使用已适配的站点，不需要关注此功能。你也可以跳过 AI 分析，手动配置选择器。

### 环境配置

在控制面板 → 设置 → 环境配置中修改，**需重启服务生效**。

| 分类 | 配置项 | 默认值 | 说明 |
|------|--------|--------|------|
| 服务 | 监听地址 | `127.0.0.1` | `0.0.0.0` 允许外部访问 |
| 服务 | 监听端口 | `8199` | HTTP 服务端口 |
| 服务 | 调试模式 | 开启 | 开启 API 文档 `/docs` |
| 认证 | 启用认证 | 关闭 | 是否要求 Bearer Token |
| 代理 | 代理地址 | — | 支持 `socks5://` 或 `http://` |
| 浏览器 | Chrome 调试端口 | `9222` | 浏览器远程调试端口 |

> 完整参数说明请查阅根目录下的 **[参数解释.md](./参数解释.md)** 文件。

### 浏览器常量

在控制面板 → 设置 → 浏览器常量中修改，**即时生效**。包括操作延迟、元素查找超时、响应检测参数等。**大部分情况下保持默认即可，无需修改。**

---

## ⚠️ 重要注意事项与已知限制

### 🛑 运行中请勿干扰浏览器

当工作流正在执行时：
* **禁止操作**：不要去点击网页上的任何按钮（特别是不要替脚本点击"发送"）
* **禁止切屏**：尽量不要切换浏览器的标签页或最小化窗口
* **禁止折叠**：不要手动缩小页面边框或折叠某些按钮
* **后果**：人为干预会导致脚本逻辑错乱，引发**脚本死锁 (Deadlock)** 或产生预期之外的行为
* **正确做法**：你可以静静地看着浏览器自动操作，不要动手。如果脚本卡死，请关闭 CMD 窗口，**重启 `start.bat`**

### 📉 特殊格式抓取限制

在使用提取器（DOM 模式）进行内容提取时存在一定局限性：
* **代码块、LaTeX 与超链接**：脚本**可能无法完整捕捉**，或者抓取结果出现格式错误
* 如果主要用于角色扮演等纯文本场景，DOM 模式完全够用
* 如果用于写代码，可切换为**网络拦截模式**（非流式，但目前仅部分站点已适配）

### 📏 上下文长度限制

受限于网站输入框一次性所能容纳的字符上限，上下文不能太长，否则请求会直接失败。可以开启「文件粘贴」功能来绕过部分限制。

### 🌐 关于 arena.ai

该站点非常看重 IP 质量。**IP 好的可以一直对话，IP 不好的一次就会被拦截。** 建议**不要**开启网络拦截模式（网络监听会创建额外的浏览器连接，增加被检测概率）。

### 🐛 已知问题

- DeepSeek 思考模式下存在读取问题
- VSCode 中 **Codex** 插件不适配，原因未知
- DrissionPage 补丁需在每次升级后重新执行

---

## ❓ 常见问题 (FAQ)

### Q1: 运行 start.bat 后闪退，或者浏览器没有弹出来

程序会按以下优先级自动检测浏览器：Chrome → Edge → Brave → Vivaldi → Opera。如果都未找到，可以在 `.env` 文件中手动指定：
```
BROWSER_PATH=C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe
```

### Q2: 网页配置打不开 (http://127.0.0.1:8199 无法访问)

- 检查黑色的命令行窗口是否被关闭了？CMD 窗口必须一直开着
- 检查端口 8199 是否被其他软件占用

### Q3: 为什么发消息给 AI 后，一直显示"等待中"或超时？

1. **观察浏览器**：切到自动弹出的浏览器看一眼
   - 如果是网速慢，网页还没加载出来 → 请刷新网页
   - 如果是弹出了验证码 → 请手动帮机器人点一下验证码
2. **调整配置**：在工作流中适当增加"等待时间"
3. **检查干扰**：请确认你没有在脚本运行时手动点击过网页

### Q4: 使用时频繁失败怎么办？

请按以下顺序排查：
1. **人为干涉了工作流**：脚本执行过程中不能操作脚本控制的浏览器
2. **折叠边框**：必须将折叠元素全部展开（浏览器可以最小化但不能缩小边框）
3. **网站状态异常**：可能触发了人机验证、单次发送信息太长被拒绝、或内容包含违规信息
4. **网络问题**：网络波动或代理切换 IP 导致发送失败，可能引发脚本死锁，需要重启脚本或等待约 5 分钟
5. **多余标签页**：关闭除 AI 网站之外的其他标签页（如教程页、搜索页）
6. **站点配置失效**：网站更新后选择器可能失效，可在 GitHub 提 Issue 或加群反馈

### Q5: 总是提示 "Context Too Long"

这取决于你登录的网页版账号权益。如果你用的是免费版 ChatGPT，上下文通常限制在 8k 左右。这是网站的限制，不是本软件的限制。

### Q6: 标签页池中看不到新打开的标签页？

- 新标签页的网页是否已经**加载完成**（空白页不会被识别）
- 等待 2-3 秒后点击「立即刷新」按钮
- 如果仍然看不到，重启脚本即可

### Q7: 控制面板的参数应该怎么调？

**大多数时候不需要调整**，所有参数都有经过优化的默认值，可以满足绝大多数使用场景。

### Q8: 这个项目有什么用？

- **免费额度利用**：将网页端免费额度转化为 OpenAI 格式的 API
- **调试上下文**：便捷查看前端如何构造上下文
- **多标签页 + 多预设**：同时开多个标签页实现多用途并行
- **长文本绕过**：通过文件粘贴功能绕过部分网站输入框的字符限制

---

## 📁 项目结构

```
📁 Universal-Web-API/
├── 📁 app/                  # 🐍 Python 后端核心代码库
│   ├── 📁 api/              # [接口层] HTTP 请求处理
│   ├── 📁 core/             # [核心层] 浏览器自动化与底层逻辑
│   │   ├── 📁 extractors/   # 提取策略（深度/DOM/混合/图片）
│   │   ├── 📁 parsers/      # 各站点专用内容解析器
│   │   └── 📁 workflow/     # 工作流执行引擎
│   ├── 📁 models/           # [数据模型层] Pydantic 数据结构
│   ├── 📁 services/         # [业务逻辑层] 配置引擎、请求调度
│   └── 📁 utils/            # [工具层] 剪贴板、图片处理等
├── 📁 config/               # 🔧 配置文件目录
│   ├── sites.json           # 站点数据库（URL、选择器、工作流）
│   ├── browser_config.json  # 浏览器启动配置
│   ├── extractors.json      # 提取器配置
│   └── image_presets.json   # 图片预设配置
├── 📁 static/               # 🎨 前端静态资源（Web UI 控制面板）
├── .env                     # 🔒 环境变量
├── main.py                  # ▶️ 程序主入口
├── start.bat                # 🚀 Windows 一键启动脚本
├── requirements.txt         # 📦 Python 依赖列表
└── 参数解释.md               # 📝 配置参数详细说明
```

## 依赖

**后端：**
- FastAPI - Web 框架
- uvicorn - ASGI 服务器
- DrissionPage - 浏览器自动化
- beautifulsoup4 - HTML 解析
- pydantic - 数据验证

**前端：**
- [Vue.js](https://vuejs.org/) - JavaScript 框架

---

## 后续开发

| 计划 | 状态 |
|------|------|
| 增加并发能力 | 🚧 进行中 |
| Cookie 模拟模式（低资源占用，无需浏览器） | 🚧 规划中 |
| Bug 修复 | 🔄 持续进行 |

### 两种模式规划

| 模式 | 适用场景 | 优势 | 劣势 | 状态 |
|------|---------|------|------|------|
| **浏览器自动化模式** | 防护严格的网站（ChatGPT、Claude、Grok 等） | 完全模拟真实用户、可绕过大部分检测 | 资源占用高、响应速度较慢 | ✅ **当前支持** |
| **Cookie 模拟模式** | 防护宽松的网站（部分开源 AI、本地部署等） | 资源占用低、响应速度快、无需浏览器 | 需分析请求结构、容易被检测 | 🚧 **规划中** |

---

## ⚖️ 免责声明

**请在使用本项目前仔细阅读以下声明**

### 使用目的

本项目 (Universal Web-to-API) 仅供**学习、研究和技术交流**使用，旨在探索浏览器自动化技术和 API 设计模式。

### 服务条款合规

1. **用户责任**：使用本项目访问任何第三方网站时，您必须遵守该网站的服务条款 (Terms of Service)、使用协议及相关法律法规。
2. **自动化限制**：许多网站明确禁止或限制自动化访问行为。使用本项目可能违反这些网站的服务条款，导致账号封禁、IP 封锁或法律诉讼风险。
3. **使用建议**：
   - 仅在目标网站明确允许自动化访问的情况下使用
   - 优先使用官方提供的 API（如有）
   - 控制请求频率，避免对服务器造成负担
   - 不要用于商业用途或大规模自动化

### 风险提示

- **账号风险**：目标网站可能检测并封禁您的账号
- **数据风险**：自动化过程中可能导致数据丢失或泄露
- **法律风险**：某些司法管辖区可能认定此类行为违法
- **安全风险**：第三方依赖库可能存在安全漏洞

### 隐私和数据

1. 本项目在本地运行，不会主动收集或上传您的任何数据
2. 您需自行确保辅助 AI API（如配置）的数据安全性
3. 请勿在生产环境或处理敏感数据时使用本项目

### 责任限制

本项目作者和贡献者**不对以下情况承担任何责任**：使用本项目导致的账号封禁、数据丢失等任何直接或间接损失；违反第三方服务条款产生的法律后果；因项目缺陷、错误或故障造成的任何损害。

本项目按"现状"(AS IS) 提供，**不提供任何明示或暗示的保证**。

### 开源协议

本项目采用 **AGPL-3.0 许可证**。允许修改和分发，但必须保持相同的开源协议。如果您修改本项目并通过网络提供服务，必须公开源代码。

### 特别提醒

- ⚠️ 切勿将本项目用于任何非法用途
- ⚠️ 切勿用于规避付费服务或侵犯知识产权
- ⚠️ 切勿对目标网站进行高频请求或恶意攻击
- ⚠️ 建议仅在测试环境中使用
- ⚠️ 商业使用前请咨询法律顾问

**使用本项目即表示您已阅读并理解本免责声明的全部内容，同意自行承担所有使用风险和后果。如果您不同意上述任何条款，请立即停止使用本项目。**