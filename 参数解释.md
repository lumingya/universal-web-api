# 配置参数说明文档

本文档详细解释 Universal Web-to-API 的所有配置参数。

---

## 📁 环境配置 (.env)

> ⚠️ 修改后需要**重启服务**才能生效

### 🖥️ 服务配置

| 参数 | 环境变量 | 默认值 | 说明 |
|------|----------|--------|------|
| 监听地址 | `APP_HOST` | `127.0.0.1` | 服务绑定的 IP 地址。`127.0.0.1` 仅本机访问，`0.0.0.0` 允许外部访问 |
| 监听端口 | `APP_PORT` | `8199` | HTTP 服务监听的端口号 |
| 调试模式 | `APP_DEBUG` | `false` | 开启后显示 API 文档 (`/docs`) 和详细错误信息 |
| 日志级别 | `LOG_LEVEL` | `INFO` | 可选: `DEBUG`、`INFO`、`WARNING`、`ERROR`。DEBUG 会输出大量调试信息 |

**使用场景：**
- 开发调试时：`APP_DEBUG=true`、`LOG_LEVEL=DEBUG`
- 生产环境：`APP_DEBUG=false`、`LOG_LEVEL=INFO`
- 需要远程访问：`APP_HOST=0.0.0.0`

---

### 🔐 认证配置

| 参数 | 环境变量 | 默认值 | 说明 |
|------|----------|--------|------|
| 启用认证 | `AUTH_ENABLED` | `false` | 是否要求 API 调用时提供 Bearer Token |
| Bearer Token | `AUTH_TOKEN` | 空 | 认证令牌，启用认证时必须设置 |

**生成安全 Token：**
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

**调用示例：**
```bash
curl -H "Authorization: Bearer your-token-here" http://localhost:8199/v1/chat/completions
```

---

### 🌐 CORS 配置

| 参数 | 环境变量 | 默认值 | 说明 |
|------|----------|--------|------|
| 启用 CORS | `CORS_ENABLED` | `true` | 是否允许跨域请求 |
| 允许的源 | `CORS_ORIGINS` | `*` | 允许的跨域来源，`*` 表示全部允许，多个用逗号分隔 |

**示例：**
```ini
CORS_ORIGINS=https://example.com,https://app.example.com
```

---

### 🌍 浏览器配置

| 参数 | 环境变量 | 默认值 | 说明 |
|------|----------|--------|------|
| Chrome 调试端口 | `BROWSER_PORT` | `9222` | Chrome 浏览器的远程调试端口 |

**启动 Chrome 时需指定相同端口：**
```bash
chrome.exe --remote-debugging-port=9222
```

---

### 📊 Dashboard 配置

| 参数 | 环境变量 | 默认值 | 说明 |
|------|----------|--------|------|
| 启用 Dashboard | `DASHBOARD_ENABLED` | `true` | 是否启用 Web 管理界面 |
| 文件路径 | `DASHBOARD_FILE` | `dashboard.html` | Dashboard 入口文件路径 |

---

### 🤖 AI 分析配置

> 用于 AI 辅助分析页面元素（自动生成选择器）

| 参数 | 环境变量 | 默认值 | 说明 |
|------|----------|--------|------|
| API Key | `HELPER_API_KEY` | 空 | 辅助 AI 的 API 密钥 |
| API 地址 | `HELPER_BASE_URL` | 空 | 辅助 AI 的 API 基础 URL |
| 模型名称 | `HELPER_MODEL` | `gpt-4` | 使用的模型名称 |
| HTML 最大字符 | `MAX_HTML_CHARS` | `120000` | 发送给 AI 的 HTML 最大长度，超出会截断 |

**配置示例（使用 OpenAI）：**
```ini
HELPER_API_KEY=sk-xxxx
HELPER_BASE_URL=https://api.openai.com/v1
HELPER_MODEL=gpt-4
```

---

### 📁 配置文件

| 参数 | 环境变量 | 默认值 | 说明 |
|------|----------|--------|------|
| 站点配置路径 | `SITES_CONFIG_FILE` | `config/sites.json` | 站点选择器配置文件位置 |

---

## 🌐 浏览器常量 (browser_config.json)

> ✅ 修改后**即时生效**（无需重启）

### 🔌 连接配置

| 参数 | 键名 | 默认值 | 说明 |
|------|------|--------|------|
| 调试端口 | `DEFAULT_PORT` | `9222` | Chrome DevTools 远程调试端口 |
| 连接超时 | `CONNECTION_TIMEOUT` | `10` 秒 | 连接浏览器的超时时间 |

---

### ⏱️ 操作延迟

> 模拟人类操作的随机延迟，防止被网站检测为机器人

| 参数 | 键名 | 默认值 | 说明 |
|------|------|--------|------|
| 隐身延迟下限 | `STEALTH_DELAY_MIN` | `0.1` 秒 | 隐蔽操作的最小延迟 |
| 隐身延迟上限 | `STEALTH_DELAY_MAX` | `0.3` 秒 | 隐蔽操作的最大延迟 |
| 动作延迟下限 | `ACTION_DELAY_MIN` | `0.15` 秒 | 点击/输入等动作的最小延迟 |
| 动作延迟上限 | `ACTION_DELAY_MAX` | `0.3` 秒 | 点击/输入等动作的最大延迟 |

**调优建议：**
- 网站检测严格：增大延迟范围
- 追求速度：减小延迟（可能触发反爬）

---

### 🔍 元素查找

| 参数 | 键名 | 默认值 | 说明 |
|------|------|--------|------|
| 默认等待时间 | `DEFAULT_ELEMENT_TIMEOUT` | `3` 秒 | 查找元素的默认超时 |
| 备用等待时间 | `FALLBACK_ELEMENT_TIMEOUT` | `1` 秒 | 首次失败后重试的超时 |
| 缓存有效期 | `ELEMENT_CACHE_MAX_AGE` | `5` 秒 | 元素位置缓存时间 |

**调优建议：**
- 页面加载慢：增大 `DEFAULT_ELEMENT_TIMEOUT`
- 动态内容多：减小 `ELEMENT_CACHE_MAX_AGE`

---

### 📡 流式监控（核心参数）

> 控制 AI 回复的流式输出检测逻辑

| 参数 | 键名 | 默认值 | 说明 |
|------|------|--------|------|
| 检查间隔下限 | `STREAM_CHECK_INTERVAL_MIN` | `0.1` 秒 | 最快多久检查一次页面变化 |
| 检查间隔上限 | `STREAM_CHECK_INTERVAL_MAX` | `1.0` 秒 | 最慢多久检查一次 |
| 默认检查间隔 | `STREAM_CHECK_INTERVAL_DEFAULT` | `0.3` 秒 | 初始检查间隔 |
| **静默超时阈值** | `STREAM_SILENCE_THRESHOLD` | `6.0` 秒 | 🔑 无新内容多久后判定完成 |
| 静默超时备用 | `STREAM_SILENCE_THRESHOLD_FALLBACK` | `10.0` 秒 | 慢速模型的备用阈值 |
| 最大超时 | `STREAM_MAX_TIMEOUT` | `600` 秒 | 单次响应的绝对超时上限 |
| 初始等待 | `STREAM_INITIAL_WAIT` | `180` 秒 | 等待首次响应的最长时间 |
| **稳定判定次数** | `STREAM_STABLE_COUNT_THRESHOLD` | `5` 次 | 🔑 连续多少次检查不变才判定完成 |

**退出条件公式：**
```
生成结束 = (稳定次数 >= STREAM_STABLE_COUNT_THRESHOLD) 
         AND (静默时间 > STREAM_SILENCE_THRESHOLD)
```

**调优建议：**

| 场景 | 静默阈值 | 稳定次数 | 说明 |
|------|----------|----------|------|
| 快速响应（GPT-4o） | 3-5 秒 | 3-5 次 | 减少等待时间 |
| 慢速思考（o1/Claude） | 10-15 秒 | 8-12 次 | 防止提前截断 |
| 代码生成 | 8-10 秒 | 6-8 次 | 代码块渲染需要时间 |

---

### ⚙️ 流式监控（高级参数）

> 通常不需要修改，除非遇到特定问题

| 参数 | 键名 | 默认值 | 说明 |
|------|------|--------|------|
| 重渲染等待 | `STREAM_RERENDER_WAIT` | `0.5` 秒 | 等待页面重新渲染的时间 |
| 内容收缩容忍 | `STREAM_CONTENT_SHRINK_TOLERANCE` | `3` 字符 | 允许内容变短的字符数（处理抖动） |
| 最小有效长度 | `STREAM_MIN_VALID_LENGTH` | `10` 字符 | 响应被视为有效的最小长度 |
| 初始元素等待 | `STREAM_INITIAL_ELEMENT_WAIT` | `10` 秒 | 等待响应元素出现的时间 |
| 最大异常次数 | `STREAM_MAX_ABNORMAL_COUNT` | `5` 次 | 连续异常多少次后中止 |
| 最大元素丢失 | `STREAM_MAX_ELEMENT_MISSING` | `10` 次 | 元素持续丢失多少次后退出 |
| 内容收缩阈值 | `STREAM_CONTENT_SHRINK_THRESHOLD` | `0.3` | 内容缩减超过 30% 视为异常（如思考块折叠） |

---

### ✅ 输入验证

| 参数 | 键名 | 默认值 | 说明 |
|------|------|--------|------|
| 消息最大长度 | `MAX_MESSAGE_LENGTH` | `100000` 字符 | 单条消息的最大字符数 |
| 消息最大数量 | `MAX_MESSAGES_COUNT` | `100` 条 | 单次请求的最大消息数 |

---

## 🎯 常见调优场景

### 场景 1：AI 回复被提前截断

**症状：** 回复到一半就结束了

**解决：** 增大静默阈值和稳定次数
```json
{
  "STREAM_SILENCE_THRESHOLD": 10,
  "STREAM_STABLE_COUNT_THRESHOLD": 8
}
```

### 场景 2：等待时间太长

**症状：** AI 已经回复完成，但还在等待

**解决：** 减小静默阈值
```json
{
  "STREAM_SILENCE_THRESHOLD": 3,
  "STREAM_STABLE_COUNT_THRESHOLD": 3
}
```

### 场景 3：思考模型（如 o1）超时

**症状：** 思考时间长导致超时

**解决：** 增大初始等待时间
```json
{
  "STREAM_INITIAL_WAIT": 300,
  "STREAM_MAX_TIMEOUT": 900
}
```

### 场景 4：页面元素找不到

**症状：** 报错"元素未找到"

**解决：** 增大元素等待时间
```json
{
  "DEFAULT_ELEMENT_TIMEOUT": 5,
  "STREAM_INITIAL_ELEMENT_WAIT": 15
}
```

---

## 📝 配置文件位置

| 文件 | 路径 | 格式 | 生效方式 |
|------|------|------|----------|
| 环境配置 | `.env` | KEY=VALUE | 重启生效 |
| 浏览器常量 | `config/browser_config.json` | JSON | 即时生效 |
| 站点配置 | `config/sites.json` | JSON | 即时生效 |
```
