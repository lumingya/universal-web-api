<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web-to-API 使用教程</title>
    <style>
        :root {
            --sidebar-width: 280px;
            --primary-color: #2563eb;
            --text-color: #334155;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
            --code-bg: #1e293b;
            --code-text: #e2e8f0;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --info-bg: #eff6ff;
            --info-border: #3b82f6;
            --info-text: #1e40af;
            --note-bg: #fffbeb;
            --note-border: #f59e0b;
            --note-text: #92400e;
            --highlight-bg: #fff1f2;
            --highlight-border: #e11d48;
            --highlight-text: #9f1239;
            --success-bg: #f0fdf4;
            --success-border: #10b981;
            --success-text: #065f46;
            --config-bg: #f0fdf4;
            --config-border: #bbf7d0;
            --troubleshoot-bg: #fefce8;
            --troubleshoot-border: #fef08a;
            --troubleshoot-text: #854d0e;
            --site-card-bg: #f8fafc;
            --site-card-hover-bg: #eff6ff;
            --site-card-model-bg: #e2e8f0;
            --site-card-model-text: #64748b;
            --th-bg: #f8fafc;
            --code-inline-bg: #f1f5f9;
            --code-inline-text: #be185d;
            --h1-color: #1e293b;
            --h3-color: #475569;
            --desc-color: #64748b;
        }

        [data-theme="dark"] {
            --primary-color: #60a5fa;
            --text-color: #cbd5e1;
            --bg-color: #0f172a;
            --border-color: #334155;
            --sidebar-bg: #1e293b;
            --card-bg: #1e293b;
            --info-bg: #1e3a5f;
            --info-border: #3b82f6;
            --info-text: #93c5fd;
            --note-bg: #422006;
            --note-border: #f59e0b;
            --note-text: #fcd34d;
            --highlight-bg: #4c0519;
            --highlight-border: #f43f5e;
            --highlight-text: #fda4af;
            --success-bg: #052e16;
            --success-border: #10b981;
            --success-text: #6ee7b7;
            --config-bg: #052e16;
            --config-border: #065f46;
            --troubleshoot-bg: #422006;
            --troubleshoot-border: #854d0e;
            --troubleshoot-text: #fcd34d;
            --site-card-bg: #1e293b;
            --site-card-hover-bg: #1e3a5f;
            --site-card-model-bg: #334155;
            --site-card-model-text: #94a3b8;
            --th-bg: #334155;
            --code-inline-bg: #334155;
            --code-inline-text: #f472b6;
            --h1-color: #e2e8f0;
            --h3-color: #94a3b8;
            --desc-color: #94a3b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            top: 0;
            left: 0;
            z-index: 100;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .sidebar h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .nav-link {
            display: block;
            padding: 10px 15px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--info-bg);
            color: var(--primary-color);
            font-weight: 500;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: var(--site-card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 0.9rem;
            transition: all 0.2s;
            width: 100%;
        }

        .theme-toggle:hover {
            border-color: var(--primary-color);
            background: var(--info-bg);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 40px 60px;
            width: 100%;
            max-width: 1200px;
        }

        section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            scroll-margin-top: 20px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        h1, h2, h3 {
            color: var(--h1-color);
            margin-bottom: 1rem;
        }

        h1 { font-size: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        h2 { font-size: 1.5rem; margin-top: 10px; border-left: 4px solid var(--primary-color); padding-left: 10px; }
        h3 { font-size: 1.2rem; margin-top: 20px; color: var(--h3-color); }

        p { margin-bottom: 1rem; }

        ul, ol { padding-left: 1.5rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }

        code {
            background-color: var(--code-inline-bg);
            padding: 0.2em 0.5em;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            color: var(--code-inline-text);
            font-size: 0.9em;
        }

        pre {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            margin: 1.5rem 0;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        pre::before {
            content: '';
            display: block;
            height: 32px;
            background: linear-gradient(90deg, #334155 0%, #1e293b 100%);
            border-bottom: 1px solid #475569;
        }

        pre::after {
            content: '● ● ●';
            position: absolute;
            top: 8px;
            left: 12px;
            font-size: 10px;
            letter-spacing: 4px;
            color: #64748b;
        }

        pre code {
            display: block;
            padding: 20px;
            overflow-x: auto;
            color: #e2e8f0;
            background: transparent;
            font-size: 0.875rem;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .site-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .site-card {
            background: var(--site-card-bg);
            border: 1px solid var(--border-color);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .site-card:hover {
            border-color: var(--primary-color);
            background: var(--site-card-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .site-card::before {
            content: "🔗";
            margin-right: 10px;
            font-size: 0.9rem;
        }

        .site-card .model-id {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--site-card-model-text);
            background: var(--site-card-model-bg);
            padding: 2px 8px;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: var(--th-bg);
            font-weight: 600;
        }

        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }

        .note {
            background-color: var(--note-bg);
            border-left: 4px solid var(--note-border);
            padding: 15px 20px;
            margin-bottom: 1.5rem;
            color: var(--note-text);
            border-radius: 0 8px 8px 0;
        }

        .info-box {
            background: var(--info-bg);
            border-left: 4px solid var(--info-border);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            color: var(--info-text);
        }

        .highlight-box {
            background: var(--highlight-bg);
            border-left: 4px solid var(--highlight-border);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            color: var(--highlight-text);
        }

        .success-box {
            background: var(--success-bg);
            border-left: 4px solid var(--success-border);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            color: var(--success-text);
        }

        .config-box {
            background: var(--config-bg);
            border: 1px solid var(--config-border);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .config-box ul { margin-bottom: 0; }

        .troubleshoot-list {
            background: var(--troubleshoot-bg);
            border: 1px solid var(--troubleshoot-border);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
        }

        .troubleshoot-list ol { margin-bottom: 0; }
        .troubleshoot-list li { margin-bottom: 10px; color: var(--troubleshoot-text); }

        .config-group {
            margin-bottom: 25px;
        }

        .config-group h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            color: var(--h3-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--border-color);
        }

        .config-group .icon { font-size: 1.2rem; }

        @media (max-width: 900px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>📑 目录导航</h2>
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="themeIcon">🌙</span>
            <span id="themeText">夜间模式</span>
        </button>
        <nav>
            <a href="#quick-start" class="nav-link">🚀 快速开始</a>
            <a href="#connect-api" class="nav-link">🔌 连接 API</a>
            <a href="#tab-pool" class="nav-link">🗂️ 标签页池</a>
            <a href="#presets" class="nav-link">🎛️ 预设系统</a>
            <a href="#selectors" class="nav-link">🔍 选择器配置</a>
            <a href="#extractors" class="nav-link">🧩 提取器配置</a>
            <a href="#image-extraction" class="nav-link">🖼️ 图片提取配置</a>
            <a href="#response-detection" class="nav-link">🌊 响应检测配置</a>
            <a href="#workflow" class="nav-link">🎬 工作流配置</a>
            <a href="#file-paste" class="nav-link">📄 文件粘贴</a>
            <a href="#stealth-mode" class="nav-link">🛡️ 隐身模式</a>
            <a href="#ai-recognition" class="nav-link">🎯 AI 元素识别</a>
            <a href="#env-config" class="nav-link">⚙️ 环境配置</a>
            <a href="#browser-config" class="nav-link">🌐 浏览器常量</a>
            <a href="#config-manage" class="nav-link">💾 配置管理</a>
            <a href="#faq" class="nav-link">❓ 常见问题</a>
        </nav>
    </div>

    <div class="main-content">
        <h1>Universal Web-to-API 使用手册 (v2.3.1)</h1>

        <!-- ==================== 快速开始 ==================== -->
        <section id="quick-start">
            <h2>🚀 快速开始</h2>
            <p>欢迎使用 Web-to-API。本项目将网页版 AI 对话界面转换为标准 OpenAI 兼容 API。</p>

            <div class="info-box">
                <p><strong>📌 核心提示：</strong> 脚本启动后会自动打开当前这个浏览器窗口，<strong style="color: var(--highlight-border);">请保持该浏览器窗口处于开启状态</strong>，它是服务运行的基础。本教程标签页在运行后请手动关闭，否则可能干扰脚本操作。</p>
            </div>

            <div class="note">
                <p><strong>控制面板入口：</strong></p>
                <a href="/" class="btn" target="_blank">打开控制面板</a>
                <p style="margin-top: 10px;">控制面板地址：<code>http://127.0.0.1:8199/</code>，可在这里可视化地修改所有配置、查看实时日志。</p>
            </div>

            <h3>✅ 已适配的站点列表</h3>
            <p>以下网站已做好适配，可以直接访问并连接 API：</p>

            <div class="site-grid" id="siteGrid"></div>

            <div class="highlight-box">
                <p><strong>⚠️ 关于 arena.ai：</strong>该站点非常看重 IP 质量。<strong>IP 好的可以一直对话，IP 不好的一次就会被拦截</strong>。IP 好坏不仅取决于纯净度，更重要的是<strong>历史行为和共享人数</strong>——有时候机房 IP 会比原生双 ISP 更具优势。经测试，即便关闭网络监听模式，IP 质量不佳时仍会频繁触发 Cloudflare 人机验证。这是站点本身的安全策略，与脚本无关。<br><small style="opacity: 0.8;">（感谢测试者 @喵团子爱摸鱼 的反馈）</small></p>
            </div>

            <h3>🆕 对于未收录的网站（自动适配）</h3>
            <p>如果目标网站不在上述列表中，系统支持通过 AI 自动分析网页结构。详见下方「AI 元素识别配置」章节。</p>
        </section>

        <!-- ==================== 连接 API ==================== -->
        <section id="connect-api">
            <h2>🔌 连接 API</h2>
            <p>本项目提供兼容 <strong>OpenAI 格式</strong> 的接口。</p>

            <div class="config-box">
                <p><strong>⚙️ 客户端通用配置参数：</strong></p>
                <ul>
                    <li><strong>服务提供商 (Provider)</strong>：选择 <code>OpenAI</code>、<code>OpenAI 兼容</code> 或 <code>自定义</code>。</li>
                    <li><strong>API 接口地址 (Base URL)</strong>：
                        <ul>
                            <li>默认（自动分配标签页）：<code>http://127.0.0.1:8199/v1</code></li>
                            <li>指定标签页：<code>http://127.0.0.1:8199/tab/1/v1</code>（编号见标签页池）</li>
                            <li>部分软件需完整路径：<code>http://127.0.0.1:8199/v1/chat/completions</code></li>
                        </ul>
                    </li>
                    <li><strong>API 密钥 (API Key)</strong>：任意填写即可（例如：<code>sk-any</code>）。</li>
                    <li><strong>模型名称 (Model)</strong>：取决于你访问的网站。你访问什么网站，实际就是什么模型，所以该项可随意填写。</li>
                </ul>
            </div>

            <div class="success-box">
                <p><strong>✅ 测试步骤：</strong>当你按照第一步打开了站点并登录之后，填写了对应的 URL 和服务商内容，就可以直接进行测试了。</p>
            </div>

            <h3>💡 关于登录状态</h3>
            <ul>
                <li><strong>推荐登录</strong>：建议在网页上登录你的账号，这样 API 也就拥有了你的账号权限（如 Plus 会员、历史记录等）。</li>
                <li><strong>免登录</strong>：如果该网站在未登录状态下允许对话（如 LM Arena），则无需登录即可直接通过 API 调用。</li>
            </ul>

            <div class="note">
                <p><strong>⚠️ 关于 SillyTavern (酒馆):</strong> 在酒馆中使用 API 测试功能可能会出现 bug，<strong>建议直接发送对话进行测试</strong>，而非点击测试按钮。</p>
            </div>

            <div class="highlight-box">
                <p><strong>⚠️ 上下文长度限制：</strong>受限于网站输入框一次性所能容纳的字符上限，上下文不能太长，否则请求会直接失败。请根据实际情况控制对话长度。对于长文本场景，可以开启「文件粘贴」功能来绕过部分限制。</p>
            </div>

            <h3>已测试站点单次最大发送长度：</h3>
            <ul>
                <li><strong>ChatGPT</strong>：约 200k。</li>
                <li><strong>Gemini 官网</strong>：无会员约 30k，Pro 会员尚未发现上限。</li>
                <li><strong>LM Arena</strong>：120k。</li>
            </ul>
        </section>

        <!-- ==================== 标签页池 ==================== -->
        <section id="tab-pool">
            <h2>🗂️ 标签页池</h2>
            <p>标签页池是本项目的核心调度机制。脚本会自动扫描浏览器中打开的所有 AI 网站标签页，并为每个标签页分配一个<strong>持久编号</strong>。</p>

            <h3>工作原理</h3>
            <ol>
                <li>你在浏览器中打开一个或多个 AI 网站标签页（如 ChatGPT、Gemini 等）</li>
                <li>脚本自动检测并将它们加入标签页池，分配编号（1, 2, 3...）</li>
                <li>API 请求到达时，自动选择一个空闲的标签页来处理</li>
                <li>处理完成后，标签页被释放回池中，等待下一个请求</li>
            </ol>

            <h3>两种路由方式</h3>
            <table>
                <tr><th>路由</th><th>地址格式</th><th>说明</th></tr>
                <tr>
                    <td><strong>默认路由</strong></td>
                    <td><code>/v1/chat/completions</code></td>
                    <td>自动选择一个空闲标签页处理请求</td>
                </tr>
                <tr>
                    <td><strong>指定标签页</strong></td>
                    <td><code>/tab/{编号}/v1/chat/completions</code></td>
                    <td>使用特定编号的标签页，如果该标签页忙碌则排队等待</td>
                </tr>
            </table>

            <div class="info-box">
                <p><strong>💡 何时使用指定标签页：</strong></p>
                <ul style="margin-bottom: 0;">
                    <li>当你想让某个客户端始终使用特定的 AI 站点时</li>
                    <li>当你为不同标签页配置了不同的预设时（见下方「预设系统」）</li>
                    <li>当你需要确保对话的连续性时</li>
                </ul>
            </div>

            <h3>在控制面板中管理</h3>
            <p>在控制面板中点击「标签页」选项卡，可以：</p>
            <ul>
                <li>查看所有标签页的实时状态（空闲/忙碌/错误）</li>
                <li>查看每个标签页的当前 URL 和请求计数</li>
                <li>复制指定标签页的 API 端点地址</li>
                <li>为标签页切换不同的预设配置</li>
            </ul>

            <div class="note">
                <p><strong>⚠️ 注意事项：</strong></p>
                <ul style="margin-bottom: 0;">
                    <li>标签页编号在脚本运行期间保持不变，重启后会重新分配</li>
                    <li>关闭浏览器中的标签页后，对应的编号会自动释放</li>
                    <li>新打开的标签页会在几秒内被自动检测到并加入池中</li>
                    <li><code>chrome://newtab</code> 等空白页不会被加入池，页面加载完成后才会被识别</li>
                </ul>
            </div>
        </section>

        <!-- ==================== 预设系统 ==================== -->
        <section id="presets">
            <h2>🎛️ 预设系统</h2>
            <p>预设系统允许你为同一个站点创建<strong>多套独立的配置方案</strong>，并将不同预设分配给不同的标签页。</p>

            <h3>典型应用场景</h3>
            <table>
                <tr><th>标签页</th><th>预设名称</th><th>配置差异</th></tr>
                <tr>
                    <td>标签页 #1</td>
                    <td>Pro 模型对话</td>
                    <td>完整工作流（含 new_chat_btn）、较长超时、启用深度提取</td>
                </tr>
                <tr>
                    <td>标签页 #2</td>
                    <td>快速识图</td>
                    <td>简化工作流、启用图片提取、较短超时</td>
                </tr>
                <tr>
                    <td>标签页 #3</td>
                    <td>代码助手</td>
                    <td>启用文件粘贴、高阈值、启用网络监听模式</td>
                </tr>
            </table>

            <h3>如何使用预设</h3>

            <p><strong>1. 创建预设</strong></p>
            <ol>
                <li>在控制面板中选择一个站点</li>
                <li>在「配置」选项卡顶部可以看到预设选择器</li>
                <li>点击「＋ 新建预设」，输入名称后创建</li>
                <li>新预设会克隆当前选中预设的所有配置</li>
                <li>然后可以独立修改新预设的选择器、工作流、提取器等配置</li>
            </ol>

            <p><strong>2. 为标签页分配预设</strong></p>
            <ol>
                <li>切换到「标签页」选项卡</li>
                <li>在对应标签页的行中找到「预设」下拉框</li>
                <li>选择想要使用的预设即可</li>
            </ol>

            <p><strong>3. 通过 API 使用指定预设的标签页</strong></p>
            <pre><code># 假设标签页 #1 使用"Pro 模型对话"预设，标签页 #2 使用"快速识图"预设

# 使用 Pro 模型对话
curl http://127.0.0.1:8199/tab/1/v1/chat/completions

# 使用快速识图
curl http://127.0.0.1:8199/tab/2/v1/chat/completions</code></pre>

            <div class="info-box">
                <p><strong>💡 提示：</strong>每个预设包含独立的选择器、工作流、流式配置、图片提取、文件粘贴等全套配置。修改一个预设不会影响其他预设。</p>
            </div>

            <h3>预设配置结构</h3>
            <pre><code>{
  "gemini.google.com": {
    "presets": {
      "主预设": {
        "selectors": { ... },
        "workflow": [ ... ],
        "stream_config": { ... },
        "image_extraction": { "enabled": false },
        "file_paste": { "threshold": 50000 }
      },
      "快速识图": {
        "selectors": { ... },
        "workflow": [ ... ],
        "image_extraction": { "enabled": true, "mode": "first" },
        "file_paste": { "threshold": 10000 }
      }
    }
  }
}</code></pre>

            <div class="note">
                <p><strong>⚠️ 注意：</strong>删除预设不可撤销，且至少需要保留一个预设。如果只有一个预设，删除按钮会被禁用。</p>
            </div>
        </section>

        <!-- ==================== 选择器配置 ==================== -->
        <section id="selectors">
            <h2>🔍 选择器配置 (Selectors)</h2>
            <p>每个站点（的每个预设）都需要定义一组 CSS 选择器，告诉程序去哪里输入、哪里点击。</p>
            <pre><code>"selectors": {
  "input_box": "textarea[id='prompt']",   // 输入框
  "send_btn": "button.send-btn",          // 发送按钮
  "result_container": ".markdown-body",   // AI 回复所在的容器
  "new_chat_btn": "button.new-chat",      // 新建对话按钮
  "temp_chat_btn": "button.temp-chat"     // 临时对话按钮 (自定义)
}</code></pre>
            <ul>
                <li><strong>input_box</strong>: 必填。聊天输入框。</li>
                <li><strong>send_btn</strong>: 必填。发送按钮。</li>
                <li><strong>result_container</strong>: 必填。包含 AI 回复内容的容器。</li>
                <li><strong>new_chat_btn</strong>: 选填。每次新会话开始时点击的按钮。</li>
            </ul>

            <div class="info-box">
                <p><strong>💡 自定义选择器：</strong>你可以自己新增选择器，比如新增一个「临时对话按钮」，然后在工作流里添加点击这个按钮的步骤，程序就会在执行时多点一步临时对话。</p>
            </div>

            <div class="success-box">
                <p><strong>🧪 测试选择器：</strong>在控制面板的选择器配置项中点击「测试」按钮可以验证选择器是否生效，也可以在「工作流可视化」中查看配置是否正确。</p>
            </div>
        </section>

        <!-- ==================== 提取器配置 ==================== -->
        <section id="extractors">
            <h2>🧩 提取器配置 (Extractors)</h2>
            <p>提取器决定了如何从网页 HTML 中解析出干净的 Markdown 文本。</p>
            <pre><code>// 在站点配置中为预设配置提取器
{
  "extractor_id": "deep_mode_v1",  // 使用深度模式
  ...
}</code></pre>
            <ul>
                <li><strong>默认模式</strong>: 自动提取 <code>result_container</code> 中的文本。</li>
                <li><strong>deep_mode (深度模式)</strong>: 针对复杂的 LaTeX 公式、代码块进行特殊处理。</li>
            </ul>

            <div class="note">
                <p><strong>⚠️ 注意：</strong>目前只有<strong>深度模式 (deep_mode)</strong> 是经过深度优化的，其他模式都处于未完善状态。</p>
            </div>

            <div class="info-box">
                <p><strong>💡 复杂内容处理：</strong>即使是深度模式，某些复杂的代码块也可能无法正确处理。这种情况下，可以在「响应检测配置」中开启<strong>网络拦截模式</strong>，它能处理所有情况，但目前只针对部分站点做了适配，且不支持流式输出。</p>
            </div>
        </section>

        <!-- ==================== 图片提取配置 ==================== -->
        <section id="image-extraction">
            <h2>🖼️ 图片提取配置</h2>
            <p>配置程序如何处理网页中生成的图片。</p>
            <pre><code>"image_extraction": {
  "enabled": true,                // 是否开启图片提取
  "selector": "img",              // 图片元素的选择器
  "container_selector": ".img-grid", // (可选) 限定在特定区域查找
  "download_blobs": true,         // 是否下载 blob/src 图片到本地
  "mode": "all",                  // all: 提取所有图; first: 仅第一张
  "max_size_mb": 10               // 最大允许大小
}</code></pre>
            <p><strong>文件保存位置：</strong></p>
            <ul>
                <li><strong>发送的图片</strong>: 保存在根目录 <code>image/</code>。</li>
                <li><strong>捕获的图片</strong>: 保存在根目录 <code>download_images/</code>。</li>
            </ul>
        </section>

        <!-- ==================== 响应检测配置 ==================== -->
        <section id="response-detection">
            <h2>🌊 响应检测配置</h2>
            <p>定义如何判断 AI 正在输出以及何时结束。支持两种检测模式：</p>

            <table>
                <tr><th>模式</th><th>是否流式</th><th>说明</th></tr>
                <tr>
                    <td><strong>DOM 模式</strong>（默认）</td>
                    <td>✅ 流式</td>
                    <td>轮询检测页面 DOM 变化，实时输出内容。适用于绝大多数场景</td>
                </tr>
                <tr>
                    <td><strong>网络拦截模式</strong></td>
                    <td>❌ 非流式</td>
                    <td>拦截浏览器网络请求，AI 生成完毕后一次性返回完整内容</td>
                </tr>
            </table>

            <h3>DOM 模式（默认推荐）</h3>
            <p>DOM 模式通过轮询页面内容变化来检测 AI 的输出，支持流式返回。对不同网站的兼容性有所差异，<strong>普遍存在代码块读取不完整的问题</strong>（因为代码块的 HTML 渲染结构较复杂）。如果你主要用于角色扮演等纯文本场景，DOM 模式完全够用；如果用于写代码，可能需要配合网络拦截模式。</p>

            <h4>检测逻辑</h4>
            <pre><code>生成结束判定 = (连续稳定次数 ≥ 稳定判定次数) AND (静默时间 > 静默超时阈值)</code></pre>
            <p><strong>工作原理：</strong></p>
            <ol>
                <li>脚本每隔「默认检查间隔」秒检查一次页面内容</li>
                <li>如果内容有变化，重置计数器</li>
                <li>如果内容没变化，稳定次数 +1，静默时间累加</li>
                <li>当两个条件同时满足时，判定 AI 生成完成</li>
                <li>如果超过「初始等待」时间仍未检测到内容，判定失败</li>
            </ol>

            <h4>调优建议</h4>
            <table>
                <tr><th>场景</th><th>静默超时阈值</th><th>稳定判定次数</th><th>初始等待</th></tr>
                <tr><td>快速模型 (GPT-4o)</td><td>3-5 秒</td><td>3-5 次</td><td>60 秒</td></tr>
                <tr><td>慢速思考 (o1/Claude)</td><td>10-15 秒</td><td>8-12 次</td><td>300 秒</td></tr>
                <tr><td>代码生成</td><td>8-10 秒</td><td>6-8 次</td><td>180 秒</td></tr>
                <tr><td>长文生成</td><td>12-15 秒</td><td>10 次</td><td>300 秒</td></tr>
            </table>

            <h3>网络拦截模式</h3>

            <div class="highlight-box">
                <p><strong>⚠️ 重要提醒：</strong>网络拦截模式目前仅针对部分站点做了适配。<strong>如果某个站点默认没有开启网络拦截，请不要手动开启</strong>——大概率是没有适配，或者开启后会产生副作用（如增加被 Cloudflare 检测的风险）。</p>
            </div>

            <p>网络拦截模式通过拦截浏览器的 XHR/Fetch 请求来获取 AI 的完整回复，能完美处理代码块等复杂内容。但由于 DrissionPage 不支持流式读取网络响应，<strong>所有内容必须等 AI 完全生成后才能一次性返回</strong>，因此不支持流式输出。</p>

            <div class="info-box">
                <p><strong>💡 启用方式：</strong>在控制面板的站点配置中，找到「流式配置」面板，将模式切换为「网络拦截」即可。</p>
            </div>

            <h4>网络拦截配置项</h4>
            <table>
                <tr><th>配置项</th><th>说明</th><th>示例</th></tr>
                <tr>
                    <td><strong>URL 匹配模式</strong></td>
                    <td>网络请求 URL 中包含此字符串时拦截（必填）</td>
                    <td><code>GenerateContent</code></td>
                </tr>
                <tr>
                    <td><strong>响应解析器</strong></td>
                    <td>用于解析拦截到的响应数据的解析器 ID（必填）</td>
                    <td>根据站点自动匹配</td>
                </tr>
                <tr>
                    <td><strong>首次响应超时</strong></td>
                    <td>等待 AI 返回完整回复的最长时间。由于非流式特性，这实际上是<strong>整个回复的生成超时</strong>，而不是首个字符的等待时间</td>
                    <td><code>300</code> 秒</td>
                </tr>
                <tr>
                    <td><strong>静默超时</strong></td>
                    <td>拦截到响应后，多久没有新数据判定为完成</td>
                    <td><code>3</code> 秒</td>
                </tr>
                <tr>
                    <td><strong>轮询间隔</strong></td>
                    <td>检查是否有新的网络响应的频率</td>
                    <td><code>0.5</code> 秒</td>
                </tr>
            </table>

            <h4>通用配置项（两种模式共用）</h4>
            <table>
                <tr><th>配置项</th><th>说明</th><th>默认值</th></tr>
                <tr>
                    <td><strong>全局硬超时</strong></td>
                    <td>单次请求的绝对超时上限，超过此时间无论如何都会结束。在现有情景下与首次超时并无绝对区别</td>
                    <td><code>300</code> 秒</td>
                </tr>
                <tr>
                    <td><strong>静默超时 (DOM)</strong></td>
                    <td>网路监听模式下的静默超时阈值</td>
                    <td><code>3</code> 秒</td>
                </tr>
                <tr>
                    <td><strong>初始等待</strong></td>
                    <td>等待 AI 开始回复的最长时间</td>
                    <td><code>30</code> 秒</td>
                </tr>
            </table>

            <div class="note">
                <p><strong>💡 关于超时配置：</strong>在网络拦截模式下，「首次响应超时」和「全局硬超时」实际效果相似，因为 DrissionPage 不支持流式返回——首次响应就是完整响应。建议两者设为相同的值。对于慢速思考模型（如 o1），可能需要设为 300 秒以上。</p>
            </div>

            <div class="highlight-box">
                <p><strong>⚠️ 关于 arena.ai：</strong>该站点建议<strong>不要</strong>开启网络拦截模式。因为网络监听会创建额外的浏览器连接，增加被 Cloudflare 检测到的概率。请使用默认的 DOM 模式。</p>
            </div>
        </section>

        <!-- ==================== 工作流配置 ==================== -->
        <section id="workflow">
            <h2>🎬 工作流配置 (Workflow)</h2>
            <p>定义一系列动作的执行顺序。每个预设可以有独立的工作流。</p>
            <pre><code>"workflow": [
  { "action": "CLICK", "target": "new_chat_btn" },
  { "action": "WAIT", "value": 0.5 },
  { "action": "FILL_INPUT", "target": "input_box" },
  { "action": "CLICK", "target": "send_btn" },
  { "action": "STREAM_WAIT" }
]</code></pre>
            <table>
                <tr><th>动作类型</th><th>说明</th></tr>
                <tr><td><code>CLICK</code></td><td>点击元素 (target 为选择器 key)</td></tr>
                <tr><td><code>FILL_INPUT</code></td><td>在输入框填入用户问题</td></tr>
                <tr><td><code>WAIT</code></td><td>等待固定时间 (value 为秒数)</td></tr>
                <tr><td><code>KEY_PRESS</code></td><td>模拟按键 (如 Enter)</td></tr>
                <tr><td><code>STREAM_WAIT</code></td><td>等待响应完成</td></tr>
            </table>
        </section>

        <!-- ==================== 文件粘贴 ==================== -->
        <section id="file-paste">
            <h2>📄 文件粘贴</h2>
            <p>当发送的文本长度超过设定的阈值时，系统会自动将文本写入临时 <code>.txt</code> 文件，然后以文件粘贴的方式发送到输入框。这可以绕过部分网站对输入框字符数的限制。</p>

            <h3>配置项说明</h3>
            <table>
                <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                <tr><td>启用</td><td>关闭</td><td>是否开启文件粘贴模式</td></tr>
                <tr><td>阈值</td><td><code>50000</code> 字符</td><td>文本长度超过此值时触发文件粘贴</td></tr>
                <tr><td>引导文本</td><td><code>完全专注于文件内容</code></td><td>粘贴文件后自动在输入框中追加的文字</td></tr>
            </table>

            <div class="info-box">
                <p><strong>💡 适用场景：</strong>文件粘贴模式仅适用于<strong>支持文件上传</strong>的 AI 网站（如 Gemini、ChatGPT 等）。如果目标网站不支持文件上传，开启此功能会导致发送失败。</p>
            </div>

            <h3>配置方式</h3>
            <p>在控制面板的「配置」选项卡中找到「文件粘贴」面板，可以针对每个站点（的每个预设）独立配置。也支持批量启用/禁用所有站点。</p>

            <div class="note">
                <p><strong>⚠️ 注意：</strong>引导文本的作用是确保 AI 能正确理解粘贴的文件内容。如果留空，部分网站可能不会自动读取文件。</p>
            </div>
        </section>

        <!-- ==================== 隐身模式 ==================== -->
        <section id="stealth-mode">
            <h2>🛡️ 隐身模式</h2>
            <p>隐身模式用于绕过网站的反自动化检测（如 Cloudflare 人机验证）。开启后，脚本的所有操作（点击、鼠标移动、滚动等）都会模拟真实人类行为。</p>

            <h3>何时需要开启</h3>
            <ul>
                <li><strong>需要开启</strong>：访问有 Cloudflare 防护的站点（如 arena.ai、chatgpt.com 等）</li>
                <li><strong>不需要开启</strong>：访问无防护或低防护的站点（如 AI Studio、DeepSeek 等）</li>
            </ul>

            <div class="info-box">
                <p><strong>💡 如何开启：</strong>在控制面板中选择站点后，在页面顶部勾选「隐身模式」复选框即可。该设置是每个预设独立的。</p>
            </div>

            <h3>隐身模式做了什么</h3>
            <table>
                <tr><th>行为</th><th>普通模式</th><th>隐身模式</th></tr>
                <tr><td>鼠标点击</td><td>直接 CDP 命令</td><td>模拟真实鼠标按压（含 pressure、微移、释放偏移）</td></tr>
                <tr><td>鼠标移动</td><td>瞬间跳转</td><td>人类化曲线移动</td></tr>
                <tr><td>空闲时</td><td>无动作</td><td>随机微漂移（模拟手部抖动）</td></tr>
                <tr><td>滚动</td><td>直接调用</td><td>纯 CDP 滚轮事件</td></tr>
                <tr><td>操作间隔</td><td>最小延迟</td><td>随机化延迟（0.1-0.3 秒）</td></tr>
            </table>

            <h3>DrissionPage 补丁</h3>
            <p>为了最大程度减少被检测的风险，本项目需要对 DrissionPage 库进行一个小补丁，让网络监听功能复用浏览器的主连接而非创建额外的连接。</p>
            <ul>
                <li><strong>自动执行</strong>：<code>start.bat</code> 启动脚本会在依赖安装后自动执行补丁</li>
                <li><strong>手动执行</strong>：<code>python patch_drissionpage.py</code></li>
                <li><strong>恢复原文件</strong>：<code>python patch_drissionpage.py --restore</code></li>
            </ul>

            <div class="note">
                <p><strong>⚠️ 注意：</strong>每次升级 DrissionPage 后需要重新执行补丁。补丁支持重复执行（幂等），不会重复打补丁。</p>
            </div>

            <div class="highlight-box">
                <p><strong>⚠️ 关于 arena.ai 的特别说明：</strong>即便开启了隐身模式并关闭了网络监听，在半小时内连续对话约 10 条也几乎一定会触发 Cloudflare 人机验证。这是该站点本身的安全策略，真人操作也同样会触发，并非脚本问题。</p>
            </div>
        </section>

        <!-- ==================== AI 元素识别 ==================== -->
        <section id="ai-recognition">
            <h2>🎯 AI 元素识别配置</h2>
            <p>当你访问的站点不在已适配列表中时，系统可以调用 AI 自动分析网页结构，识别出输入框、发送按钮等关键元素。</p>

            <div class="info-box">
                <p><strong>📍 配置位置：</strong>进入 <a href="/">控制面板</a> → 设置 → AI 元素识别</p>
            </div>

            <h3>配置项说明</h3>
            <table>
                <tr><th>字段</th><th>说明</th></tr>
                <tr><td><strong>排序</strong></td><td>调整识别项的优先级顺序</td></tr>
                <tr><td><strong>关键词 (Key)</strong></td><td>AI 需要查找的元素标识，如 <code>input_box</code>、<code>send_btn</code> 等</td></tr>
                <tr><td><strong>描述 (Description)</strong></td><td>给 AI 的提示语，描述这个元素是什么，便于 AI 准确定位</td></tr>
                <tr><td><strong>启用</strong></td><td>是否启用该识别项</td></tr>
                <tr><td><strong>操作</strong></td><td>编辑或删除该识别项</td></tr>
            </table>

            <h3>默认识别项</h3>
            <table>
                <tr><th>关键词</th><th>描述</th><th>必需</th></tr>
                <tr><td><code>input_box</code></td><td>用户输入文本的输入框（textarea 或 contenteditable 元素）</td><td>✅</td></tr>
                <tr><td><code>send_btn</code></td><td>发送消息的按钮（通常是 type=submit 或带有发送图标的按钮）</td><td>✅</td></tr>
                <tr><td><code>result_container</code></td><td>AI 回复内容的容器（仅包含 AI 的输出文本，不含用户消息）</td><td>✅</td></tr>
                <tr><td><code>new_chat_btn</code></td><td>新建对话的按钮（点击后开始新的对话）</td><td>❌</td></tr>
                <tr><td><code>message_wrapper</code></td><td>消息完整容器（包裹单条消息的外层元素）</td><td>❌</td></tr>
                <tr><td><code>generating_indicator</code></td><td>生成中指示器（如停止按钮、加载动画）</td><td>❌</td></tr>
            </table>

            <h3>使用流程（AI 自动配置）</h3>
            <ol>
                <li><strong>配置 API</strong>：在控制面板 → 设置 → 环境配置 → AI 分析配置中，填写你自己的 OpenAI 格式 API 地址和 Key。</li>
                <li><strong>访问新站点</strong>：在浏览器中打开一个未适配的网站。</li>
                <li><strong>触发识别</strong>：向本服务接口 (<code>http://127.0.0.1:8199</code>) 发送一条测试消息。</li>
                <li><strong>自动分析</strong>：系统会调用你配置的 API 分析网页，大约消耗 <strong>8000 tokens</strong>（一次性消耗）。</li>
            </ol>

            <div class="note">
                <p><strong>💡 提示：</strong>如果你只使用已经配置好的站点，则不需要关注此功能。如果你想自己新增站点，可以利用此功能让 AI 帮你自动配置参数，配置效果取决于 AI 的能力。</p>
            </div>

            <div class="note">
                <p><strong>💡 手动配置流程：</strong>如果你有一定技术水平，也可以自行配置：</p>
                <ol>
                    <li><strong>不配置 API</strong>：不填写 API，这样自动配置将会失效。</li>
                    <li><strong>获取默认配置</strong>：失败后，系统会自动分配一个默认配置，需要刷新才能看到。</li>
                    <li><strong>手动配置</strong>：到目标网站手动获取各个选择器名并填入对应框中。</li>
                    <li><strong>进行测试</strong>：在工作流中点击可视化按钮查看配置是否正确，或直接点击测试按钮。</li>
                </ol>
            </div>
        </section>

        <!-- ==================== 环境配置 ==================== -->
        <section id="env-config">
            <h2>⚙️ 环境配置</h2>
            <p>在控制面板 → 设置 → 环境配置中修改，<strong>需重启服务生效</strong>。</p>

            <div class="config-group">
                <h4><span class="icon">🖥️</span> 服务配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>监听地址</td><td><code>127.0.0.1</code></td><td>0.0.0.0 允许外部访问，127.0.0.1 仅本地</td></tr>
                    <tr><td>监听端口</td><td><code>8199</code></td><td>HTTP 服务端口</td></tr>
                    <tr><td>调试模式</td><td>开启</td><td>开启 API 文档 (/docs) 和详细错误信息</td></tr>
                    <tr><td>日志级别</td><td><code>INFO</code></td><td>DEBUG / INFO / WARNING / ERROR</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">🔐</span> 认证配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>启用认证</td><td>关闭</td><td>是否要求 API 调用时提供 Bearer Token</td></tr>
                    <tr><td>Bearer Token</td><td>空</td><td>启用认证时必须设置</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">🌐</span> CORS 配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>启用 CORS</td><td>开启</td><td>是否允许跨域请求</td></tr>
                    <tr><td>允许的跨域源</td><td><code>*</code></td><td>多个用逗号分隔，* 表示全部允许</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">🔀</span> 代理配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>启用代理</td><td>关闭</td><td>开启后浏览器将通过代理服务器访问网络</td></tr>
                    <tr><td>代理地址</td><td><code>socks5://127.0.0.1:1080</code></td><td>支持 socks5:// 或 http:// 协议</td></tr>
                    <tr><td>绕过代理</td><td><code>localhost,127.0.0.1</code></td><td>不走代理的地址，多个用逗号分隔</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">🌍</span> 浏览器配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>Chrome 调试端口</td><td><code>9222</code></td><td>浏览器远程调试端口</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">📊</span> Dashboard 配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>启用 Dashboard</td><td>开启</td><td>是否开启 Web 控制面板</td></tr>
                    <tr><td>Dashboard 文件路径</td><td><code>dashboard.html</code></td><td>入口文件位置</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">🤖</span> AI 分析配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>API Key</td><td>空</td><td>辅助 AI 的 API 密钥</td></tr>
                    <tr><td>API 地址</td><td><code>http://127.0.0.1:5104/v1</code></td><td>API 基础 URL</td></tr>
                    <tr><td>模型名称</td><td><code>gemini-3.0-pro</code></td><td>使用的模型名称</td></tr>
                    <tr><td>HTML 最大字符数</td><td><code>120000</code></td><td>超过会截断以节省 Token</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">📁</span> 配置文件</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>站点配置文件路径</td><td><code>sites.json</code></td><td>站点配置存放位置</td></tr>
                </table>
            </div>
        </section>

        <!-- ==================== 浏览器常量 ==================== -->
        <section id="browser-config">
            <h2>🌐 浏览器常量</h2>
            <p>在控制面板 → 设置 → 浏览器常量中修改，<strong>即时生效</strong>。</p>

            <div class="config-group">
                <h4><span class="icon">🔌</span> 连接配置</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>调试端口</td><td><code>9222</code></td><td>Chrome DevTools 远程调试端口</td></tr>
                    <tr><td>连接超时</td><td><code>10</code> 秒</td><td>浏览器连接超时时间</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">⏱️</span> 操作延迟</h4>
                <p style="color: var(--desc-color); font-size: 0.9rem; margin-bottom: 10px;">模拟人类操作的随机延迟范围，防止被网站检测为机器人</p>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>隐身延迟下限</td><td><code>0.1</code> 秒</td><td>隐蔽操作的最小延迟</td></tr>
                    <tr><td>隐身延迟上限</td><td><code>0.3</code> 秒</td><td>隐蔽操作的最大延迟</td></tr>
                    <tr><td>动作延迟下限</td><td><code>0.15</code> 秒</td><td>点击/输入等动作的最小延迟</td></tr>
                    <tr><td>动作延迟上限</td><td><code>0.3</code> 秒</td><td>点击/输入等动作的最大延迟</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">🔍</span> 元素查找</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>默认等待时间</td><td><code>3</code> 秒</td><td>查找元素的默认超时</td></tr>
                    <tr><td>备用等待时间</td><td><code>1</code> 秒</td><td>首次失败后的重试超时</td></tr>
                    <tr><td>缓存有效期</td><td><code>5</code> 秒</td><td>元素位置缓存时间</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">📡</span> 响应检测</h4>
                <p style="color: var(--desc-color); font-size: 0.9rem; margin-bottom: 10px;">控制 AI 响应的检测频率和超时判定</p>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>检查间隔下限</td><td><code>0.1</code> 秒</td><td>轮询检测的最快频率</td></tr>
                    <tr><td>检查间隔上限</td><td><code>1.0</code> 秒</td><td>轮询检测的最慢频率</td></tr>
                    <tr><td>默认检查间隔</td><td><code>0.3</code> 秒</td><td>初始轮询间隔</td></tr>
                    <tr><td><strong>静默超时阈值</strong></td><td><code>8.0</code> 秒</td><td>🔑 内容不再变化多久后判定完成</td></tr>
                    <tr><td>静默超时备用</td><td><code>12</code> 秒</td><td>慢速模型的宽限时间</td></tr>
                    <tr><td>最大超时</td><td><code>600</code> 秒</td><td>单次请求的绝对超时上限</td></tr>
                    <tr><td>初始等待</td><td><code>180</code> 秒</td><td>等待 AI 开始回复的最长时间</td></tr>
                    <tr><td><strong>稳定判定次数</strong></td><td><code>8</code> 次</td><td>🔑 连续多少次检查内容不变判定完成</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">⚙️</span> 响应检测（高级）</h4>
                <p style="color: var(--desc-color); font-size: 0.9rem; margin-bottom: 10px;">通常不需要修改</p>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>重渲染等待</td><td><code>0.5</code> 秒</td><td>等待页面重新渲染</td></tr>
                    <tr><td>内容收缩容忍次数</td><td><code>3</code> 次</td><td>允许内容变短的次数</td></tr>
                    <tr><td>最小有效长度</td><td><code>10</code> 字符</td><td>响应被视为有效的最小长度</td></tr>
                    <tr><td>初始元素等待</td><td><code>10</code> 秒</td><td>等待响应元素出现的时间</td></tr>
                    <tr><td>最大异常次数</td><td><code>5</code> 次</td><td>连续异常多少次后中止</td></tr>
                    <tr><td>最大元素丢失次数</td><td><code>10</code> 次</td><td>元素持续丢失多少次后退出</td></tr>
                    <tr><td>内容收缩阈值</td><td><code>0.3</code></td><td>内容缩减超过 30% 视为异常</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">✅</span> 输入验证</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>消息最大长度</td><td><code>100000</code> 字符</td><td>单条消息的最大字符数</td></tr>
                    <tr><td>消息最大数量</td><td><code>100</code> 条</td><td>单次请求的最大消息数</td></tr>
                </table>
            </div>

            <div class="config-group">
                <h4><span class="icon">🖼️</span> 图片发送</h4>
                <table>
                    <tr><th>配置项</th><th>默认值</th><th>说明</th></tr>
                    <tr><td>上传历史对话中的图片</td><td>开启</td><td>是否把历史消息里的图片也一起上传</td></tr>
                </table>
            </div>
        </section>

        <!-- ==================== 配置管理 ==================== -->
        <section id="config-manage">
            <h2>💾 配置管理</h2>
            <ul>
                <li><strong>保存</strong>: 在控制面板修改配置后，点击「保存」按钮，更改会立即写入配置文件。</li>
                <li><strong>热重载</strong>: 大部分配置修改后立即生效，无需重启程序（环境配置除外）。</li>
                <li><strong>导入/导出</strong>: 支持导出全量配置或单个站点配置为 JSON 文件，也可以导入配置文件。</li>
                <li><strong>预设管理</strong>: 每个站点的预设可以独立创建、删除、切换。预设的导出包含在站点配置中。</li>
                <li><strong>备份</strong>: 建议定期备份 <code>config/</code> 目录。</li>
            </ul>

            <div class="highlight-box">
                <p><strong>⚠️ 警告：</strong>目前可视化编辑器<strong>没有撤销功能</strong>！一旦保存无法快捷复原，请务必谨慎修改。</p>
            </div>
        </section>

        <!-- ==================== FAQ ==================== -->
        <section id="faq">
            <h2>❓ 常见问题</h2>

            <h3>Q1: 为什么酒馆显示连接失败？</h3>
            <p>A: 因为酒馆点击「测试 API」时发送的请求信息过短。特别是当你同时使用酒馆测试 API 功能并且目标站点是 AI Studio 时，容易出现这个问题。<strong>建议直接发送对话消息进行测试</strong>，而非使用测试按钮。</p>

            <h3>Q2: 使用时频繁失败怎么办？</h3>
            <p>A: 请按以下几种情况进行排查：</p>
            <div class="troubleshoot-list">
                <ol>
                    <li><strong>人为干涉了工作流</strong>：在工作流执行时，你点击了脚本控制的浏览器页面的其他按钮，或者切换了页面。在脚本执行过程中，你不能操作脚本控制的浏览器，最多只能看着。</li>
                    <li><strong>折叠边框</strong>：如果你手动把页面边框缩小，或折叠某些按钮，脚本可能无法操作元素。因此必须将折叠元素全部展开（浏览器可以最小化但不能缩小边框）。</li>
                    <li><strong>网站状态异常</strong>：查看一下脚本控制的浏览器状态，可能触发了人机验证，可能单次发送的信息太长被网站拒绝，也可能发送的内容包含违规信息被拦截。</li>
                    <li><strong>网络问题</strong>：网络波动或者代理切换了 IP，导致发送失败。这种情况可能引发脚本死锁，需要重启脚本或等待约 5 分钟。表现为：脚本后台显示发送成功，但浏览器中信息没有被实际发送或发送后又失败了。</li>
                    <li><strong>教程页看完记得关</strong>：注意，本浏览器由脚本直接操作，不要打开除 AI 网站之外的其它标签页，如搜索页面、教程页面。同时如果已经打开了并且已经出现问题，重启脚本即可。</li>
                    <li><strong>站点配置失效</strong>：如果以上问题都排除了，可能是该网站的配置已过期需要更新。你可以在 GitHub 上提 Issue 或加群反馈。如果你有一定基础，也可以手动更新选择器配置。</li>
                </ol>
            </div>

            <h3>Q3: 我同时打开了多个页面，脚本会怎么操作？</h3>
            <p>A: 脚本使用<strong>标签页池</strong>自动管理所有打开的标签页：</p>
            <ul>
                <li><strong>默认路由</strong>（<code>/v1/chat/completions</code>）：自动选择一个空闲标签页处理请求</li>
                <li><strong>指定标签页</strong>（<code>/tab/1/v1/chat/completions</code>）：使用编号为 1 的标签页</li>
                <li>你可以为不同标签页分配不同的<strong>预设</strong>，实现同一站点的多种用途（如对话 + 识图）</li>
                <li>当同时有多个请求时，空闲标签页会被依次分配；如果所有标签页都忙碌，新请求会排队等待</li>
            </ul>

            <h3>Q4: 标签页池中看不到新打开的标签页？</h3>
            <p>A: 请检查以下几点：</p>
            <ul>
                <li>新标签页的网页是否已经<strong>加载完成</strong>（`chrome://newtab` 等空白页不会被识别）</li>
                <li>等待 2-3 秒后点击「立即刷新」按钮</li>
                <li>如果仍然看不到，重启脚本即可</li>
            </ul>

            <h3>Q5: 控制面板的参数应该怎么调？需要调吗？</h3>
            <p>A: <strong>大多数时候不需要调整</strong>，里面的参数都是配置好的默认值，可以满足绝大多数使用场景。</p>

            <h3>Q6: 有什么已知问题？</h3>
            <p>A: 目前已经有一些已知的问题：</p>
            <ul>
                <li>VSCode 中已经发现 <strong>Codex</strong> 插件不适配，原因未知。</li>
                <li>DrissionPage 补丁需在每次升级 DrissionPage 后重新执行。</li>
            </ul>

            <h3>Q7: 这个项目有什么用？</h3>
            <p>A: 这是一个「白嫖」项目，主要用途包括：</p>
            <ul>
                <li><strong>免费额度利用</strong>：很多 AI 厂商在网页端有相当多的免费额度（如 DeepSeek、AI Studio、LM Arena 等），本项目能将网页额度转化为 OpenAI 格式的 API，供前端调用。</li>
                <li><strong>调试上下文</strong>：你可以便捷地查看前端是如何构造上下文的——只需打开浏览器复制一遍脚本发送的请求内容即可。</li>
                <li><strong>多标签页 + 多预设</strong>：同时开多个标签页，为不同标签页配置不同预设（如主端口用于聊天，副端口用于识图），实现多用途并行。</li>
                <li><strong>长文本绕过</strong>：通过文件粘贴功能，绕过部分网站输入框的字符限制。</li>
            </ul>

            <div class="info-box">
                <p><strong>📬 反馈渠道：</strong></p>
                <ul style="margin-bottom: 0;">
                    <li>GitHub Issues：提交 bug 或建议</li>
                    <li>QQ 群：<strong>1073037753</strong></li>
                </ul>
            </div>
        </section>
    </div>

    <script>
        // 站点配置数据（域名已更新）
        const sites = [
            { url: "https://chatgpt.com", name: "chatgpt.com", id: "chatgpt" },
            { url: "https://chat.deepseek.com", name: "chat.deepseek.com", id: "deepseek" },
            { url: "https://gemini.google.com", name: "gemini.google.com", id: "gemini" },
            { url: "https://grok.com", name: "grok.com", id: "grok" },
            { url: "https://www.doubao.com", name: "doubao.com", id: "doubao" },
            { url: "https://aistudio.google.com", name: "aistudio.google.com", id: "aistudio" },
            { url: "https://arena.ai", name: "arena.ai", id: "arena" },
            { url: "https://h2ogpte.genai.h2o.ai", name: "h2ogpte.genai.h2o.ai", id: "h2ogpte" }
        ];

        // 渲染站点卡片
        function renderSiteGrid() {
            const grid = document.getElementById('siteGrid');
            grid.innerHTML = sites.map(site => `
                <a href="${site.url}" target="_blank" class="site-card">
                    ${site.name}
                    <span class="model-id">${site.id}</span>
                </a>
            `).join('');
        }

        // 夜间模式
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('tutorial-theme', next);
            updateThemeButton(next);
        }

        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = '日间模式';
            } else {
                icon.textContent = '🌙';
                text.textContent = '夜间模式';
            }
        }

        function initTheme() {
            const saved = localStorage.getItem('tutorial-theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
                updateThemeButton(saved);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeButton('dark');
            }
        }

        // 滚动高亮逻辑
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.nav-link');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });

        // 页面加载时初始化
        initTheme();
        renderSiteGrid();
    </script>
</body>
</html>